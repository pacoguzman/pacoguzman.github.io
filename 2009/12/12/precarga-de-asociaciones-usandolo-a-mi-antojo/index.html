<!DOCTYPE html>
<html>
  <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width initial-scale=1" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge">

      <title>Precarga de Asociaciones - Usandolo a mi antojo</title>
      <meta name="description" content="Personal blog about Ruby and Rails development and live experiences">
      <meta name="viewport" content="width=device-width, initial-scale=1">

      <link rel="canonical" href="https://pacoguzman.github.io/2009/12/12/precarga-de-asociaciones-usandolo-a-mi-antojo/">
      <link rel="stylesheet" href="/assets/application.css?cb=38dd5d53ee15645b619f25a3939dc4af">

      <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-58160626-1', 'auto');
          ga('send', 'pageview');

      </script>
  </head>

  <body>
    <header class="navigation">
  <div class="menu-wrapper">
    <a href="javascript:void(0)" class="logo">
      <img src="https://raw.github.com/Magnus-G/Random/master/placeholder_logo_1.png" alt="">
    </a>
    <p class="navigation-menu-button" id="js-mobile-menu">MENU</p>
    <div class="nav">
      <ul id="navigation-menu">
        
          
            <li class="nav-link"><a href="/">Riding to NoWhere</a></li>
          
        
          
            <li class="nav-link"><a href="/posts">Posts</a></li>
          
        
      </ul>
    </div>
  </div>
</header>

<script>
  $(function() {
    var menu = $('#navigation-menu');
    var menuToggle = $('#js-mobile-menu');
    var signUp = $('.sign-up');

    $(menuToggle).on('click', function(e) {
      e.preventDefault();
      menu.slideToggle(function(){
        if(menu.is(':hidden')) {
          menu.removeAttr('style');
        }
      });
    });

    // underline under the active nav item
    $(".nav .nav-link").click(function() {
      $(".nav .nav-link").each(function() {
        $(this).removeClass("active-nav-item");
      });
      $(this).addClass("active-nav-item");
      $(".nav .more").removeClass("active-nav-item");
    });
  });
</script>

    <div class="page-content">
        <div class="wrap">
            <div class="post">

  <header class="post-header">
    <h1>Precarga de Asociaciones - Usandolo a mi antojo</h1>
    <p class="meta">Dec 12, 2009</p>
  </header>

  <article class="post-content">
  <p>Si nos vamos a echar un ojo al código fuente de Rails que se encarga de la precarga de asociaciones <a href="http://github.com/rails/rails/blob/v2.3.5/activerecord/lib/active_record/association_preload.rb">preload_associations</a>, el código que se ejecuta al utilizar un :include =&gt; :patatas nos encontramos con lo siguiente:</p>

<blockquote>
  <p>Application developers should not use this module directly.</p>
</blockquote>

<p>Pero yo no estoy totalmente de acuerdo con esto y suelo utilizar la funcionalidad que ofrece este módulo a mi antojo. Por un lado no me gusta meter includes al definir las asociaciones en los modelos, sino hacerlo al recuperar los registros en los controladores y añadir los includes que necesite para las vistas que vaya a mostrar.</p>

<p>También suele ocurrir que el número de includes a utilizar es grande por lo que una vez recuperados los registros en el controlador (paginados o no) realizo la carga de las asociaciones a posteriori. (¿Por qué haberlo hecho en el modelo?)</p>

<p>Vale hasta aquí tal vez no haya sido nada convincente y seguro que mis razones sean puramente estéticas sin entrar en detalles de rendimiento. Aún así me he encontrado con un caso, tal vez un “patrón”, en el que la precarga de asociaciones puede reducir el número de query’s a realizar en la base de datos. Siempre hablando del eager loading que realiza Rails desde la versión 2.1 y cuando no se introducen condiciones en los registros asociados.</p>

<p>El caso consta de los modelos comment, user y profile descritos <a href="http://gist.github.com/254989">aquí</a></p>

<script src="https://gist.github.com/pacoguzman/254989.js"> </script>

<p>Básicamente un perfil de usuario puede ser comentado a través de un comentario root “root_graffity”. Este comentario root puede recibir comentarios “sons” y cada uno de esos comentarios acepta respuestas “replys”. En el caso de querer recuperar lo que he denominado “graffities” junto con todos sus datos debería hacer lo que muestro <a href="http://gist.github.com/254993">aquí</a></p>

<script src="https://gist.github.com/pacoguzman/254993.js"> </script>

<p>Como vemos se realizan 7 consultas  a la base de datos, y el detalle está en que a la tabla de users y profiles se accede en dos ocasiones. Esto último lo podemos evitar si realizar un precarga de asociaciones tal y como muestro <a href="http://gist.github.com/255002">aquí</a></p>

<script src="https://gist.github.com/pacoguzman/255002.js"> </script>

<p>Si estamos cargando asociaciones auto-referenciadas (o algo así), es decir, aquellas que cargan modelos de la misma clase, si esta clase necesita asociaciones de otras clases. Veo que puede ser de utilidad agrupar los modelos de la primera clase y para ese conjunto cargar sus asociaciones. Ya que lo que hace Rails en el módulo en cuestión es recuperar los registros asociados a partir de las claves que contiene la colección de registros cuyas asociaciones se quieren precargar.</p>

<p>Alé que es sábado y habrá que beberse unas cervezas! A vuestra salud!</p>

  </article>

</div>
        </div>
    </div>

    <script type="text/javascript" src="/assets/application.js?cb=23dc9061ba93ec68527e675c87e0c367"></script>
  </body>

</html>
