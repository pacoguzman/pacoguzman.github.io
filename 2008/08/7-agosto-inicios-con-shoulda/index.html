<p>Bueno ante la necesidad de incluir un apartado sobre pruebas (testing) y validación para mi proyecto fin de carrera he comenzado a utilizar Shoulda para probar mi aplicación.</p><p>Según se puede ver en una presentación de <a href="www.lacoctelera.com/porras" title="www.lacoctelera.com/porras" id="link_5">Sergio Gil</a>, su título “Más allá del testing”, la única solución para probar mi aplicación después de su implementación es el DDT “Development Driven Testing” que siempre será mejor que no testear.</p><p>Al final me decante por utilizar Shoulda también después de leer la presentación “BDD with Should” de la gente que ha desarrollado este framework de testing. Principalmente porque se pueden enlazar contextos (cierto parecido a rspec), los nombres de los tests están bien, compatible con Test::Unit, están cubiertos la mayoría de los macros de ActiveRecord y de ActionController y también tiene cierta magia con los diseños REST.</p><p>Por otro lado, no he dejado de utilizar las fixtures, que son odiadas por gran parte de la comunidad porque de momento me sobra con aprender Shoulda. Para evitar el uso de las fixtures me ha parecido interesante el uso de factorias. La gente de <a href="http://www.thoughtbot.com" title="http://www.thoughtbot.com" id="link_4">thoughtbot</a> utilizan <a href="http://www.thoughtbot.com/projects/factory_girl" title="http://www.thoughtbot.com/projects/factory_girl" id="link_3">FactoryGirl</a>.</p><p>A continuación algunos ejemplos de el uso que le he dado a shoulda para probar modelos y controladores.</p><p>Testeando modelo Artist</p><div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">should_require_attributes</span> <span class="ss">:name</span>
<span class="n">should_belong_to</span> <span class="ss">:catalog</span>
<span class="n">should_have_many</span> <span class="ss">:albums</span>
<span class="n">should_have_many</span> <span class="ss">:tracks</span>
<span class="n">should_have_named_scope</span> <span class="ss">:recent</span><span class="p">,</span> <span class="ss">:include</span> <span class="o">=&gt;</span> <span class="ss">:catalog</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s1">&#39;artists.created_at desc&#39;</span><span class="p">,</span>
  <span class="ss">:limit</span> <span class="o">=&gt;</span> <span class="mi">9</span><span class="p">,</span> <span class="ss">:group</span> <span class="o">=&gt;</span> <span class="s1">&#39;catalog_id&#39;</span>
<span class="n">should_have_named_scope</span> <span class="s1">&#39;most_played(10)&#39;</span><span class="p">,</span> <span class="ss">:joins</span> <span class="o">=&gt;</span> <span class="s2">&quot;INNER JOIN tracks on tracks.artist_id = artists.id&quot;</span><span class="p">,</span>
    <span class="ss">:select</span> <span class="o">=&gt;</span> <span class="s2">&quot;SUM(play_count) as sum_play_count, artists.*&quot;</span><span class="p">,</span>
    <span class="ss">:group</span> <span class="o">=&gt;</span> <span class="s2">&quot;tracks.artist_id&quot;</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s2">&quot;sum_play_count DESC&quot;</span><span class="p">,</span> <span class="ss">:limit</span> <span class="o">=&gt;</span> <span class="mi">10</span></code></pre></div><p>Testeando controller Artist</p><div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">ArtistsControllerTest</span> <span class="o">&lt;</span> <span class="no">Test</span><span class="o">::</span><span class="no">Unit</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="n">fixtures</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:catalogs</span><span class="p">,</span> <span class="ss">:artists</span><span class="p">,</span> <span class="ss">:albums</span><span class="p">,</span> <span class="ss">:tracks</span><span class="p">,</span> <span class="ss">:playlists</span>
  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@controller</span> <span class="o">=</span> <span class="no">ArtistsController</span><span class="o">.</span><span class="n">new</span>
    <span class="vi">@request</span>    <span class="o">=</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">TestRequest</span><span class="o">.</span><span class="n">new</span>
    <span class="vi">@response</span>   <span class="o">=</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">TestResponse</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>
  <span class="n">logged_in_as</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">context</span> <span class="s2">&quot;on GET to :index&quot;</span> <span class="k">do</span>
      <span class="n">setup</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">:catalog_id</span> <span class="o">=&gt;</span> <span class="n">catalogs</span><span class="p">(</span><span class="ss">:catalog_itunes_pacoguzman</span><span class="p">)</span><span class="o">.</span><span class="n">id</span>
      <span class="k">end</span>
      <span class="n">should_assign_to</span> <span class="ss">:catalog</span>
      <span class="n">should_assign_to</span> <span class="ss">:artists</span>
      <span class="c1">#FIXME También se asigna @recommended</span>
      <span class="n">should_assign_to</span> <span class="ss">:recommended</span>
      <span class="n">should_respond_with</span> <span class="ss">:success</span>
      <span class="n">should_not_set_the_flash</span>
      <span class="n">should_render_a_form</span> <span class="c1"># search form</span>
      <span class="n">should</span> <span class="s2">&quot;has one link to new artist page&quot;</span> <span class="k">do</span>
        <span class="n">assert_select</span> <span class="s2">&quot;a[href=?]&quot;</span><span class="p">,</span> <span class="n">new_catalog_artist_path</span><span class="p">(</span><span class="n">catalogs</span><span class="p">(</span><span class="ss">:catalog_itunes_pacoguzman</span><span class="p">)),</span>
          <span class="ss">:count</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;New artist&quot;</span>
      <span class="k">end</span>
      <span class="n">should</span> <span class="s2">&quot;has one link to back catalog page&quot;</span> <span class="k">do</span>
        <span class="n">assert_select</span> <span class="s2">&quot;a[href=?]&quot;</span><span class="p">,</span> <span class="n">catalog_path</span><span class="p">(</span><span class="n">catalogs</span><span class="p">(</span><span class="ss">:catalog_itunes_pacoguzman</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
          <span class="ss">:count</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">catalogs</span><span class="p">(</span><span class="ss">:catalog_itunes_pacoguzman</span><span class="p">)</span><span class="o">.</span><span class="n">type_catalog</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div><p>Para definir el contexto anterior he utilizado el macro logged_in_as del siguiente modo (test_helper.rb)</p><div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">logged_in_as</span><span class="p">(</span><span class="n">user</span> <span class="o">=</span> <span class="ss">:admin</span><span class="p">)</span>
  <span class="n">context</span> <span class="s2">&quot;When logged in as </span><span class="si">#{</span><span class="n">user</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
    <span class="n">setup</span> <span class="p">{</span> <span class="vi">@logged_in_user</span> <span class="o">=</span> <span class="n">login_as</span> <span class="n">user</span> <span class="p">}</span>
    <span class="k">yield</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div><p>Hasta aquí he resumido el uso que he dado a shoulda en mi aplicación, y para enlazar aquí dejo unos cuantos links:</p><ul><li><a href="http://www.thoughtbot.com/projects/shoulda">Shoulda Project</a></li><li><a href="http://dev.thoughtbot.com/shoulda/">RDoc Should</a></li><li><a href="https://github.com/thoughtbot/shoulda">GitHub Shoulda</a></li></ul>